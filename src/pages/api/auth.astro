---
// Server-side redirect to GitHub OAuth
// This endpoint handles the OAuth authentication flow
const clientId = import.meta.env.GITHUB_CLIENT_ID;

// Try multiple methods to get the correct base URL
let baseUrl = import.meta.env.PUBLIC_BASE_URL;

if (!baseUrl) {
  // Try from request URL
  const requestUrl = new URL(Astro.request.url);
  baseUrl = `${requestUrl.protocol}//${requestUrl.host}`;
  
  // If still localhost, try headers
  if (baseUrl.includes('localhost')) {
    const host = Astro.request.headers.get('host');
    const protocol = Astro.request.headers.get('x-forwarded-proto') || 
                     Astro.request.headers.get('x-forwarded-scheme') || 
                     'https';
    if (host && !host.includes('localhost')) {
      baseUrl = `${protocol}://${host}`;
    }
  }
  
  // Final fallback - use production URL if we're not on localhost
  if (baseUrl.includes('localhost')) {
    baseUrl = 'https://hct-ana.pages.dev';
  }
}

if (!clientId) {
  return new Response('GITHUB_CLIENT_ID is not configured', { 
    status: 500,
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

const state = crypto.randomUUID();
const redirectUri = `${baseUrl}/api/callback`;
const authUrl = new URL('https://github.com/login/oauth/authorize');
authUrl.searchParams.set('client_id', clientId);
authUrl.searchParams.set('redirect_uri', redirectUri);
authUrl.searchParams.set('state', state);
authUrl.searchParams.set('scope', 'repo');

// Return HTML with immediate JavaScript redirect for faster navigation
// This is faster than server-side redirect, especially in popup windows
const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="refresh" content="0; url=${authUrl.toString()}">
  <title>Redirecting to GitHub...</title>
  <script>
    // Immediate redirect - no delay
    window.location.replace(${JSON.stringify(authUrl.toString())});
  </script>
</head>
<body>
  <p>Redirecting to GitHub...</p>
  <p>If you are not redirected, <a href="${authUrl.toString()}">click here</a>.</p>
</body>
</html>`;

return new Response(html, {
  status: 200,
  headers: {
    'Content-Type': 'text/html; charset=utf-8',
    'Cache-Control': 'no-cache, no-store, must-revalidate',
  },
});
---

